name: Build app

on:
    pull_request:
        branches: [main]

permissions:
    contents: read

jobs:
    # Job 1: Code validation (lint, typecheck, format, security)
    validate:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Validate shell scripts
              run: |
                  echo "Validating shell scripts..."
                  SCRIPTS=("deploy.sh" "update.sh" "scripts/backup-db.sh" "scripts/backup-manage.sh")
                  for script in "${SCRIPTS[@]}"; do
                      if [ -f "$script" ]; then
                          echo "Checking $script..."
                          if ! bash -n "$script"; then
                              echo "Syntax error in $script"
                              exit 1
                          fi
                          echo "$script syntax OK"
                      fi
                  done

            - name: Validate code (lint, typecheck, format-check)
              run: pnpm run validate

    # Job 2: Run tests
    test:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run unit tests
              env:
                  NODE_ENV: test
                  TZ: Europe/Stockholm
              run: pnpm test:unit

            - name: Run integration tests
              env:
                  NODE_ENV: test
                  TZ: Europe/Stockholm
              run: pnpm test:integration

    # Job 3: Build application (with Next.js cache)
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Cache Next.js build
              uses: actions/cache@v4
              with:
                  path: ${{ github.workspace }}/.next/cache
                  key: nextjs-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
                  restore-keys: |
                      nextjs-${{ runner.os }}-

            - name: Build
              env:
                  POSTGRES_PASSWORD: ci-build-only
                  POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
                  POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
                  EMAIL: ${{ secrets.EMAIL }}
                  AUTH_GITHUB_ID: ${{ secrets.AUTH_GITHUB_ID }}
                  AUTH_GITHUB_SECRET: ${{ secrets.AUTH_GITHUB_SECRET }}
                  AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
                  AUTH_GITHUB_APP_ID: ${{ secrets.AUTH_GITHUB_APP_ID }}
                  AUTH_GITHUB_APP_PRIVATE_KEY: ${{ secrets.AUTH_GITHUB_APP_PRIVATE_KEY }}
                  AUTH_GITHUB_APP_INSTALLATION_ID: ${{ secrets.AUTH_GITHUB_APP_INSTALLATION_ID }}
                  GITHUB_ORG: "vasteras-stadsmission"
                  LOG_LEVEL: "error"
                  DATABASE_URL: postgres://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@db:5432/${{ env.POSTGRES_DB }}
                  DATABASE_URL_EXTERNAL: postgres://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@localhost:5432/${{ env.POSTGRES_DB }}
              run: pnpm run build

    # Job 4: Infrastructure checks (nginx, migrations)
    checks:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Verify nginx template generation
              run: |
                  cd nginx
                  ./generate-nginx-config.sh local
                  ./generate-nginx-config.sh production "example.com www.example.com" "example.com"
                  docker run --rm -v "$(pwd):/etc/nginx/conf.d" nginx:alpine nginx -t -c /etc/nginx/conf.d/local.conf 2>/dev/null || echo "Local config syntax check failed (this may be expected due to missing includes)"
                  echo "Nginx template generates configs successfully"

            - name: Verify migration files
              env:
                  POSTGRES_PASSWORD: ci-build-only
                  POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
                  POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
                  DATABASE_URL: postgres://${{ secrets.POSTGRES_USER }}:ci-build-only@localhost:5432/${{ secrets.POSTGRES_DB }}
              run: |
                  SCHEMA_CHANGES=$(pnpm drizzle-kit check)
                  if [[ $SCHEMA_CHANGES == *"Schema drift detected"* ]]; then
                    echo "Schema changes detected but no migration files found."
                    echo "Run 'pnpm run db:generate' locally to create migration files and commit them."
                    exit 1
                  fi
                  echo "Migration files are up to date with schema."
