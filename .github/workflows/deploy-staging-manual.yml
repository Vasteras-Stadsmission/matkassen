name: Deploy to Staging (Manual)

on:
    workflow_dispatch:
        inputs:
            branch:
                description: "Branch to deploy to staging"
                required: true
                default: "main"

permissions:
    contents: read
    packages: write

# Prevent concurrent deployments to staging
concurrency:
    group: staging-deploy
    cancel-in-progress: false

jobs:
    validate-and-build:
        runs-on: ubuntu-latest
        timeout-minutes: 15
        environment:
            name: staging
            url: https://staging.matcentralen.com
        steps:
            - name: Validate branch name
              id: validate
              run: |
                  BRANCH="${{ github.event.inputs.branch }}"

                  # Reject dangerous patterns
                  if [[ ! "$BRANCH" =~ ^[a-zA-Z0-9._/-]+$ ]]; then
                    echo "::error::Invalid branch name. Only alphanumeric, dots, underscores, slashes, and hyphens allowed."
                    exit 1
                  fi

                  # Reject path traversal
                  if [[ "$BRANCH" == *".."* ]]; then
                    echo "::error::Branch name cannot contain '..'"
                    exit 1
                  fi

                  # Reject leading dash (could be interpreted as option)
                  if [[ "$BRANCH" == -* ]]; then
                    echo "::error::Branch name cannot start with '-'"
                    exit 1
                  fi

                  echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ steps.validate.outputs.branch }}

            - name: Get short SHA
              id: sha
              run: |
                  SHORT_SHA=$(git rev-parse --short HEAD)
                  echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build and push
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: Dockerfile
                  push: true
                  tags: |
                      ghcr.io/vasteras-stadsmission/matkassen:staging-test
                      ghcr.io/vasteras-stadsmission/matkassen:sha-${{ steps.sha.outputs.short_sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Deploy to staging
              uses: appleboy/ssh-action@v1.2.2
              env:
                  DEPLOY_BRANCH: ${{ steps.validate.outputs.branch }}
                  DEPLOY_SHA: ${{ steps.sha.outputs.short_sha }}
              with:
                  host: ${{ secrets.SERVER_HOST_STAGING }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  command_timeout: 10m
                  envs: DEPLOY_BRANCH,DEPLOY_SHA
                  script: |
                      set -euo pipefail

                      echo "Deploying branch: $DEPLOY_BRANCH (sha: $DEPLOY_SHA)"

                      export POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD_STAGING }}"
                      export POSTGRES_USER="${{ secrets.POSTGRES_USER }}"
                      export POSTGRES_DB="${{ secrets.POSTGRES_DB }}"
                      export EMAIL="${{ secrets.EMAIL }}"
                      export AUTH_GITHUB_ID="${{ secrets.AUTH_GITHUB_ID }}"
                      export AUTH_GITHUB_SECRET="${{ secrets.AUTH_GITHUB_SECRET }}"
                      export AUTH_SECRET="${{ secrets.AUTH_SECRET }}"
                      export AUTH_GITHUB_APP_ID="${{ secrets.AUTH_GITHUB_APP_ID }}"
                      export AUTH_GITHUB_APP_PRIVATE_KEY="${{ secrets.AUTH_GITHUB_APP_PRIVATE_KEY }}"
                      export AUTH_GITHUB_APP_INSTALLATION_ID="${{ secrets.AUTH_GITHUB_APP_INSTALLATION_ID }}"
                      export GITHUB_ORG="vasteras-stadsmission"
                      export DOMAIN_NAME="staging.matcentralen.com"
                      export BRAND_NAME="Matcentralen"
                      export ENV_NAME="staging"
                      export LOG_LEVEL="debug"
                      export HELLO_SMS_TEST_MODE="true"
                      export SMS_SEND_INTERVAL="30 seconds"
                      export ANONYMIZATION_SCHEDULE="*/15 * * * *"
                      export ANONYMIZATION_INACTIVE_DURATION="5 minutes"
                      export SWIFT_PREFIX="backups/${ENV_NAME}"

                      APP_DIR=~/matkassen
                      cd "$APP_DIR"

                      echo "Fetching branch: $DEPLOY_BRANCH"
                      git fetch origin "$DEPLOY_BRANCH"

                      echo "Checking out branch: $DEPLOY_BRANCH"
                      git checkout -B "$DEPLOY_BRANCH" "FETCH_HEAD"

                      echo "Pulling image: ghcr.io/vasteras-stadsmission/matkassen:sha-$DEPLOY_SHA"
                      docker compose pull app

                      chmod +x update.sh
                      ./update.sh

                      echo "‚úÖ Successfully deployed branch '$DEPLOY_BRANCH' to staging"
                      echo "üåê Test at: https://staging.matcentralen.com"
