# Shared nginx configuration
# Include this in both local and production configs

# Gzip compression
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/javascript
    application/xml+rss
    application/json;

# Security headers (common ones)
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "DENY" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Logging configuration
access_log /var/log/nginx/access.log combined;
error_log /var/log/nginx/error.log warn;

# Basic settings
client_max_body_size 10M;

# Connection and timeout settings for resilience
keepalive_timeout 65;
keepalive_requests 100;
client_body_timeout 60;
client_header_timeout 60;
send_timeout 60;

# Rate limiting for all requests
limit_req zone=app burst=100 nodelay;

# Shared proxy settings
proxy_http_version 1.1;
# Preserve the original Host header including port (e.g., localhost:8080)
proxy_set_header Host $http_host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header X-Forwarded-Host $http_host;
proxy_set_header X-Forwarded-Port $server_port;
proxy_cache_bypass $http_upgrade;

# Proxy timeouts and resilience settings
proxy_connect_timeout 60s;
proxy_send_timeout 60s;
proxy_read_timeout 60s;
proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
proxy_next_upstream_tries 2;
proxy_next_upstream_timeout 30s;

# Enable proxy buffering by default for better performance
proxy_buffering on;
proxy_buffer_size 4k;
proxy_buffers 8 4k;
